{% extends 'base.html' %}
{% block title %}Emotion Wheel - MindCare{% endblock %}

{% block content %}
<div class="gradient-bg py-8">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">Emotion Wheel</h1>
    <p class="text-gray-600 mb-8">
      Spin the wheel to explore and process your emotions
    </p>
  </div>
</div>

<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="bg-white rounded-xl shadow-sm p-8 card-hover text-center">
    <!-- Emotion Wheel -->
    <div class="relative mb-8">
      <div class="relative mx-auto" style="width: 300px; height: 300px;">
        <!-- Wheel Container -->
        <div id="wheelContainer" class="relative w-full h-full">
          <svg id="emotionWheel" width="300" height="300" class="transform transition-transform duration-4000 ease-out">
            <!-- Wheel segments will be generated by JavaScript -->
          </svg>
          <!-- Center Circle -->
          <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-16 h-16 bg-white rounded-full shadow-lg flex items-center justify-center border-4 border-purple-500">
            <i class="fas fa-heart text-purple-500 text-xl"></i>
          </div>
        </div>
        <!-- Pointer -->
        <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-2">
          <div class="w-0 h-0 border-l-4 border-r-4 border-b-8 border-l-transparent border-r-transparent border-b-purple-600"></div>
        </div>
      </div>
    </div>

    <!-- Spin Button -->
    <div class="mb-8">
      <button id="spinBtn" class="bg-purple-500 text-white px-8 py-4 rounded-lg text-lg font-semibold hover:bg-purple-600 transition card-hover">
        <i class="fas fa-sync-alt mr-2"></i>Spin the Wheel
      </button>
    </div>

    <!-- Result Section -->
    <div id="resultSection" class="hidden">
      <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 mb-6">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">
          You landed on: <span id="selectedEmotion" class="text-purple-600"></span>
        </h2>
        <div id="emotionPrompt" class="text-lg text-gray-700 mb-6"></div>
        
        <!-- Response Area -->
        <div class="bg-white rounded-lg p-6">
          <textarea id="emotionResponse" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none" placeholder="Take a moment to reflect and write your thoughts..."></textarea>
          <div class="flex justify-between items-center mt-4">
            <button id="saveResponse" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition">
              <i class="fas fa-save mr-2"></i>Save Reflection
            </button>
            <button id="spinAgain" class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600 transition">
              <i class="fas fa-redo mr-2"></i>Spin Again
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Benefits Section -->
  <div class="mt-8 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-8">
    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Benefits of Emotional Awareness</h2>
    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="text-center">
        <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-brain text-blue-600 text-2xl"></i>
        </div>
        <h3 class="font-semibold text-gray-800 mb-2">Self-Awareness</h3>
        <p class="text-gray-600 text-sm">Better understanding of your emotional patterns</p>
      </div>
      <div class="text-center">
        <div class="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-balance-scale text-green-600 text-2xl"></i>
        </div>
        <h3 class="font-semibold text-gray-800 mb-2">Emotional Regulation</h3>
        <p class="text-gray-600 text-sm">Learn to manage and process emotions healthily</p>
      </div>
      <div class="text-center">
        <div class="bg-purple-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-users text-purple-600 text-2xl"></i>
        </div>
        <h3 class="font-semibold text-gray-800 mb-2">Better Relationships</h3>
        <p class="text-gray-600 text-sm">Improved communication and empathy</p>
      </div>
      <div class="text-center">
        <div class="bg-orange-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-lightbulb text-orange-600 text-2xl"></i>
        </div>
        <h3 class="font-semibold text-gray-800 mb-2">Personal Growth</h3>
        <p class="text-gray-600 text-sm">Develop emotional intelligence and resilience</p>
      </div>
    </div>
  </div>
</div>

<script>
class EmotionWheel {
  constructor() {
    this.emotions = [
      { name: 'Happy', color: '#FFD700', prompt: 'What made you smile today? How can you create more moments like this?' },
      { name: 'Sad', color: '#4682B4', prompt: 'What is making you feel sad? How can you be gentle with yourself right now?' },
      { name: 'Angry', color: '#DC143C', prompt: 'What triggered your anger? How can you release this feeling in a healthy way?' },
      { name: 'Grateful', color: '#32CD32', prompt: 'Write down 3 things you are grateful for today. How do they make you feel?' },
      { name: 'Anxious', color: '#FF6347', prompt: 'What is causing your anxiety? What would help you feel more calm and secure?' },
      { name: 'Peaceful', color: '#98FB98', prompt: 'What brings you peace? How can you create more peaceful moments in your day?' }
    ];
    
    this.wheel = document.getElementById('emotionWheel');
    this.spinBtn = document.getElementById('spinBtn');
    this.resultSection = document.getElementById('resultSection');
    this.selectedEmotion = document.getElementById('selectedEmotion');
    this.emotionPrompt = document.getElementById('emotionPrompt');
    this.emotionResponse = document.getElementById('emotionResponse');
    this.saveResponse = document.getElementById('saveResponse');
    this.spinAgain = document.getElementById('spinAgain');
    
    this.currentRotation = 0;
    this.isSpinning = false;
    
    this.init();
  }
  
  init() {
    this.createWheel();
    this.bindEvents();
  }
  
  createWheel() {
    const centerX = 150;
    const centerY = 150;
    const radius = 140;
    const segmentAngle = 360 / this.emotions.length;
    
    this.emotions.forEach((emotion, index) => {
      const startAngle = index * segmentAngle;
      const endAngle = (index + 1) * segmentAngle;
      
      // Create path for segment
      const path = this.createSegmentPath(centerX, centerY, radius, startAngle, endAngle);
      const pathElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      pathElement.setAttribute('d', path);
      pathElement.setAttribute('fill', emotion.color);
      pathElement.setAttribute('stroke', '#fff');
      pathElement.setAttribute('stroke-width', '2');
      this.wheel.appendChild(pathElement);
      
      // Add text
      const textAngle = startAngle + segmentAngle / 2;
      const textRadius = radius * 0.7;
      const textX = centerX + Math.cos((textAngle - 90) * Math.PI / 180) * textRadius;
      const textY = centerY + Math.sin((textAngle - 90) * Math.PI / 180) * textRadius;
      
      const textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      textElement.setAttribute('x', textX);
      textElement.setAttribute('y', textY);
      textElement.setAttribute('text-anchor', 'middle');
      textElement.setAttribute('dominant-baseline', 'middle');
      textElement.setAttribute('fill', '#fff');
      textElement.setAttribute('font-weight', 'bold');
      textElement.setAttribute('font-size', '14');
      textElement.textContent = emotion.name;
      this.wheel.appendChild(textElement);
    });
  }
  
  createSegmentPath(centerX, centerY, radius, startAngle, endAngle) {
    const startAngleRad = (startAngle - 90) * Math.PI / 180;
    const endAngleRad = (endAngle - 90) * Math.PI / 180;
    
    const x1 = centerX + Math.cos(startAngleRad) * radius;
    const y1 = centerY + Math.sin(startAngleRad) * radius;
    const x2 = centerX + Math.cos(endAngleRad) * radius;
    const y2 = centerY + Math.sin(endAngleRad) * radius;
    
    const largeArcFlag = endAngle - startAngle <= 180 ? 0 : 1;
    
    return `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;
  }
  
  bindEvents() {
    this.spinBtn.addEventListener('click', () => this.spin());
    this.saveResponse.addEventListener('click', () => this.saveReflection());
    this.spinAgain.addEventListener('click', () => this.resetWheel());
  }
  
  spin() {
    if (this.isSpinning) return;
    
    this.isSpinning = true;
    this.spinBtn.disabled = true;
    this.spinBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Spinning...';
    this.resultSection.classList.add('hidden');
    
    // Random rotation between 720 and 1440 degrees (2-4 full rotations)
    const randomRotation = 720 + Math.random() * 720;
    this.currentRotation += randomRotation;
    
    this.wheel.style.transform = `rotate(${this.currentRotation}deg)`;
    
    setTimeout(() => {
      this.showResult();
      this.isSpinning = false;
      this.spinBtn.disabled = false;
      this.spinBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Spin the Wheel';
    }, 4000);
  }
  
  showResult() {
    const segmentAngle = 360 / this.emotions.length;
    const normalizedRotation = this.currentRotation % 360;
    const adjustedRotation = (360 - normalizedRotation) % 360;
    const selectedIndex = Math.floor(adjustedRotation / segmentAngle);
    const selectedEmotion = this.emotions[selectedIndex];
    
    this.selectedEmotion.textContent = selectedEmotion.name;
    this.selectedEmotion.style.color = selectedEmotion.color;
    this.emotionPrompt.textContent = selectedEmotion.prompt;
    this.emotionResponse.value = '';
    
    this.resultSection.classList.remove('hidden');
    this.resultSection.scrollIntoView({ behavior: 'smooth' });
  }
  
  saveReflection() {
    const response = this.emotionResponse.value.trim();
    if (response) {
      // Save to localStorage for now
      const reflections = JSON.parse(localStorage.getItem('emotionReflections') || '[]');
      reflections.push({
        emotion: this.selectedEmotion.textContent,
        prompt: this.emotionPrompt.textContent,
        response: response,
        date: new Date().toISOString()
      });
      localStorage.setItem('emotionReflections', JSON.stringify(reflections));
      
      alert('Your reflection has been saved!');
      this.emotionResponse.value = '';
    } else {
      alert('Please write a reflection before saving.');
    }
  }
  
  resetWheel() {
    this.resultSection.classList.add('hidden');
    this.emotionResponse.value = '';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  new EmotionWheel();
});
</script>
{% endblock %}